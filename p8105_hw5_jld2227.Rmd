---
title: "Homework 5"
author: "James Dalgleish"
date: "November 2, 2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
#setMKLthreads(4)
```

### Problem 1

To begin, we'll download the file, extract it's contents, and clean up the unnecessary files. 
```{r data_dl}
#Download and extract source data from zip archive.
download.file(url = "http://p8105.com/data/hw5_data.zip", 
              destfile =  "hw5_data.zip")
unzip(zipfile = "hw5_data.zip", exdir = "data", junkpaths = T) #extract the files into this new directory
study_csvs <- list.files(path = "data",pattern = "^.[A-z]*.*\\.csv$", full.names = T) #grab just the real CSVs beginning with a letter and ending with a .csv, avoiding unimportant files in the archive.

#delete the extra csvs and ._data in the __MACOSX folder of the archive.
#a setdiff will include the . and .., which we can't remove, so specific commands are needed.
if ( Sys.info()['sysname'] == "Windows") {
extra_files <- list.files('data',all.files = T, "^[.].*\\.csv$", full.names = T)
#grabs the files that are csv, but begin with a period (not the real datafiles).
file.remove(extra_files) #deletes these extra csvs.
file.remove("./data/._data") #deletes this extra ._data file.
file.remove("hw5_data.zip") #deletes the zip file
}
```
Now that we have the raw data, we'll import it and convert the contents of the individual subject data into a comprehensive table in long format that is amenable to data analysis, incorporating information about the subject contained in the filename.
```{r data_import}
read_w_fn <- function(csv, basename = T) { #the basename argument ensures the function is more generalizable to future problems where the full file path is desired in the output (in which case the user can set this flag to false).
  #browser()
  if (basename) {
    
  df <- read_csv(csv) %>% #read in csv file.
    mutate(source_file = #add a column for filename from whence the rows came.
             basename(csv) #putting in a single value still allows for recycling.
           #So, this procedure will always work in this function.
              #https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html
                 )
  } else {
    df <- read_csv(csv) %>% 
    mutate(source_file = csv) #this option just takes the filename as is, without removing directory structure.
  }
}
#test reading a file with the function:
#read_w_fn(study_csvs[1])

study_data <- study_csvs   %>%  #Creates a dataframe from the columns.
   map_df(.f = read_w_fn) %>% #reads in all the csvs and puts them together into a single dataframe by binding the rows together. 
  gather(key = "week", value = "measurement", starts_with("week")) %>%  #converts weeks to long format.
  mutate(week = (str_replace(week,"week_","") %>% 
           as.numeric()), #creates a numeric week variable
         arm = str_replace(basename(source_file),"_.*$",""), #creates a categorical arm variable by removing the text after con or exp.
         subject_id = (str_extract( #extracts the subject number from the filename.
           basename(source_file), #removes the directory information from the filename.
          pattern =  "(\\d)+") %>% #specifies the numbers within the filename as the string to be extracted.
                         as.numeric()) #converts subject ID to numeric
         ) 

```

Instructions: Tidy the result; manipulate file names to include control arm and subject ID, make sure weekly observations are “tidy”, and do any other tidying that’s necessary
Make a spaghetti plot showing observations on each subject over time, and comment on differences between groups.
```{r spaghetti_plot}
spaghetti_con_exp <- ggplot(data = study_data, 
                            aes(x = week, y = measurement, color = arm, group = subject_id)) +
  geom_line()
spaghetti_con_exp #For some reason, base ggplot won't piece this together correctly.
#plotly::ggplotly(p = spaghetti_con_exp)  #it works absolutely fine in plotly.
library(plotly)
ggplotly(p = spaghetti_con_exp)
```
On the whole, it appears that the patients in the control group are generally lower in measurement than those in the experimental group. Subject 10 is anomalously high in the control condition.
### Problem 2

Now, we'll grab homicide data for analysis.
```{r}
homicide_data <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") %>% #read in data.
  mutate( victim_first = iconv(x = victim_first, from = "latin1", to =  "ASCII",sub = ""),
          victim_last = iconv(x = victim_last, from = "latin1", to =  "ASCII",sub = ""),
          #This removes nonstandard characters that cause problems with skimr.
          city_state = str_c(city,", ",state), #create city state variable by string concatenation.
          unresolved = disposition %in% c("Closed without arrest","Open/No arrest"),
          #creates a variable for whether the case was  unresolved.
          resolved = disposition %in% c("Closed by arrest")) 
#creates a variable for whether the case was resolved, to double check the numbers.
#Included the resolved cases as a separate variable to clearly show that the resolved and unresolved cases sum to the total (and hence the calculations make sense).
hom_summ_tbl <- homicide_data %>% 
  group_by(city_state) %>%  
  summarise(total = n(), #get the total number of cases by city_state combination.
            unresolved_cases = sum(unresolved), 
        #Gets the unresolved cases of each city state combination.
            resolved_cases = sum(resolved)
        #Gets the resolved cases of each city state combination.
            ) %>% 
  select(city_state, unresolved_cases, resolved_cases, total) 
  #rearranges the columns

 hom_summ_tbl %>% 
  knitr::kable(col.names = c("City, State", "Unresolved Cases", "Resolved Cases", "Total Cases"), format = "markdown", padding = 10) #Displays the table in a more presentable format.
#The numbers add up: unresolved + resolved = total.
 library(magrittr)
 balt_res <- hom_summ_tbl %>%
   filter(city_state == "Baltimore, MD") %>% 
   select(unresolved_cases, total) %>% 
   rowwise() %$% 
   prop.test(x = unresolved_cases, n = total)
 balt_res %>% 
   broom::tidy() %>% 
   kable()
 balt_ci_est <- balt_res %>% 
   broom::tidy() %>% 
   select(estimate, conf.low, conf.high)
# 
#    prop.test(hom_summ_tbl$unresolved_cases,hom_summ_tbl$total)
#    prop.test(hom_summ_tbl$unresolved_cases[1],hom_summ_tbl$total[1]) %>% broom::tidy()
   

  est_ci_cityst <- hom_summ_tbl  %>%
     mutate(ci_est =
              map2(.x = unresolved_cases, .y = total,
        .f = ~(prop.test(x = .x, n = .y) %>% broom::tidy())
     )
     ) %>% unnest() %>% 
     select(city_state, estimate, conf.low, conf.high)
  est_ci_cityst %>% 
 mutate(city_state = forcats::fct_reorder(.f = 
                           city_state %>% as.factor(),
                         estimate)
 ) %>% 
 ggplot( 
       aes(x = city_state,
           y = estimate, ymin = conf.low, ymax = conf.high)
       )  +
  geom_point() +
  geom_errorbar() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(title = "Estimated Proportion of Unresolved Homicides by City, State",
         y = "Estimated proportion", x = "City, State")
```
